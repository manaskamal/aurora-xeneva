; Listing generated by Microsoft (R) Optimizing Compiler Version 17.00.50727.1 

include listing.inc

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

CONST	SEGMENT
$SG3831	DB	'AuHandleNotPresent -> %x ', 0aH, 00H
CONST	ENDS
PUBLIC	?AuHandlePageNotPresent@@YAX_K_N@Z		; AuHandlePageNotPresent
EXTRN	printf:PROC
EXTRN	AuPmmngrAlloc:PROC
EXTRN	AuMapPage:PROC
EXTRN	?AuFindVMA@@YAPEAU_vma_area_@@_K@Z:PROC		; AuFindVMA
EXTRN	?fat32_read@@YAXPEAU_vfs_node_@@PEA_K@Z:PROC	; fat32_read
pdata	SEGMENT
$pdata$?AuHandlePageNotPresent@@YAX_K_N@Z DD imagerel $LN10
	DD	imagerel $LN10+175
	DD	imagerel $unwind$?AuHandlePageNotPresent@@YAX_K_N@Z
pdata	ENDS
xdata	SEGMENT
$unwind$?AuHandlePageNotPresent@@YAX_K_N@Z DD 010d01H
	DD	0820dH
xdata	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\xeneva\aurora\aurora\mmngr\mmfault.cpp
_TEXT	SEGMENT
i$1 = 32
vm$ = 40
phys_addr$2 = 48
vaddr$ = 80
user$ = 88
?AuHandlePageNotPresent@@YAX_K_N@Z PROC			; AuHandlePageNotPresent

; 39   : void AuHandlePageNotPresent (uint64_t vaddr, bool user) {

$LN10:
	mov	BYTE PTR [rsp+16], dl
	mov	QWORD PTR [rsp+8], rcx
	sub	rsp, 72					; 00000048H

; 40   : 	au_vm_area_t *vm = AuFindVMA(vaddr);

	mov	rcx, QWORD PTR vaddr$[rsp]
	call	?AuFindVMA@@YAPEAU_vma_area_@@_K@Z	; AuFindVMA
	mov	QWORD PTR vm$[rsp], rax

; 41   : 	if (vm == NULL){

	cmp	QWORD PTR vm$[rsp], 0
	jne	SHORT $LN7@AuHandlePa

; 42   : 		printf ("AuHandleNotPresent -> %x \n", vaddr);

	mov	rdx, QWORD PTR vaddr$[rsp]
	lea	rcx, OFFSET FLAT:$SG3831
	call	printf
$LN6@AuHandlePa:

; 43   : 		for(;;);

	jmp	SHORT $LN6@AuHandlePa
$LN7@AuHandlePa:

; 44   : 	}
; 45   : 
; 46   : 	for (int i = 0; i < vm->length; i++) {

	mov	DWORD PTR i$1[rsp], 0
	jmp	SHORT $LN4@AuHandlePa
$LN3@AuHandlePa:
	mov	eax, DWORD PTR i$1[rsp]
	inc	eax
	mov	DWORD PTR i$1[rsp], eax
$LN4@AuHandlePa:
	movsxd	rax, DWORD PTR i$1[rsp]
	mov	rcx, QWORD PTR vm$[rsp]
	cmp	rax, QWORD PTR [rcx+40]
	jae	SHORT $LN2@AuHandlePa

; 47   : 		void* phys_addr = AuPmmngrAlloc();

	call	AuPmmngrAlloc
	mov	QWORD PTR phys_addr$2[rsp], rax

; 48   : 		if (vm->file && vm->file->eof != 1) {

	mov	rax, QWORD PTR vm$[rsp]
	cmp	QWORD PTR [rax+24], 0
	je	SHORT $LN1@AuHandlePa
	mov	rax, QWORD PTR vm$[rsp]
	mov	rax, QWORD PTR [rax+24]
	movzx	eax, BYTE PTR [rax+36]
	cmp	eax, 1
	je	SHORT $LN1@AuHandlePa

; 49   : 			fat32_read(vm->file, (uint64_t*)phys_addr);

	mov	rdx, QWORD PTR phys_addr$2[rsp]
	mov	rax, QWORD PTR vm$[rsp]
	mov	rcx, QWORD PTR [rax+24]
	call	?fat32_read@@YAXPEAU_vfs_node_@@PEA_K@Z	; fat32_read
$LN1@AuHandlePa:

; 50   : 		}
; 51   : 		AuMapPage((uint64_t)phys_addr, vaddr, PAGING_USER);

	mov	r8b, 4
	mov	rdx, QWORD PTR vaddr$[rsp]
	mov	rcx, QWORD PTR phys_addr$2[rsp]
	call	AuMapPage

; 52   : 	}

	jmp	SHORT $LN3@AuHandlePa
$LN2@AuHandlePa:

; 53   : }

	add	rsp, 72					; 00000048H
	ret	0
?AuHandlePageNotPresent@@YAX_K_N@Z ENDP			; AuHandlePageNotPresent
_TEXT	ENDS
END
