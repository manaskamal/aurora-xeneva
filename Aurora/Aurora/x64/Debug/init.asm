; Listing generated by Microsoft (R) Optimizing Compiler Version 17.00.50727.1 

include listing.inc

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	?debug@@3P6AXPEBDZZEA				; debug
_BSS	SEGMENT
?debug@@3P6AXPEBDZZEA DQ 01H DUP (?)			; debug
_BSS	ENDS
CONST	SEGMENT
$SG5388	DB	'/mon.wav', 00H
	ORG $+7
$SG5389	DB	'file.size -> %d ', 0aH, 00H
	ORG $+6
$SG5406	DB	'Scheduler Initialized', 0aH, 00H
	ORG $+1
$SG5408	DB	'shell', 00H
	ORG $+2
$SG5409	DB	'/init.exe', 00H
	ORG $+2
$SG5410	DB	'priwm', 00H
	ORG $+6
$SG5411	DB	'/priwm.exe', 00H
CONST	ENDS
PUBLIC	?debug_print@@YAXPEBDZZ				; debug_print
PUBLIC	?_AuMain@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z		; _AuMain
EXTRN	x64_cli:PROC
EXTRN	x64_sti:PROC
EXTRN	x64_hlt:PROC
EXTRN	?AuInitializeCpu@@YAXE@Z:PROC			; AuInitializeCpu
EXTRN	?AuHalInitialize@@YAXXZ:PROC			; AuHalInitialize
EXTRN	?AuPmmngrInit@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z:PROC ; AuPmmngrInit
EXTRN	AuPmmngrAlloc:PROC
EXTRN	AuPmmngrFree:PROC
EXTRN	p2v:PROC
EXTRN	v2p:PROC
EXTRN	?AuPagingInit@@YAXXZ:PROC			; AuPagingInit
EXTRN	AuMapPage:PROC
EXTRN	?AuPagingClearLow@@YAXXZ:PROC			; AuPagingClearLow
EXTRN	?AuConsoleInitialize@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z:PROC ; AuConsoleInitialize
EXTRN	memset:PROC
EXTRN	memcpy:PROC
EXTRN	printf:PROC
EXTRN	?AuKeyboardInitialize@@YAXXZ:PROC		; AuKeyboardInitialize
EXTRN	?AuInitializeMouse@@YAXXZ:PROC			; AuInitializeMouse
EXTRN	?AuHeapInitialize@@YAXXZ:PROC			; AuHeapInitialize
EXTRN	?ahci_initialize@@YAXXZ:PROC			; ahci_initialize
EXTRN	?AuInitializeRTC@@YAXXZ:PROC			; AuInitializeRTC
EXTRN	?AuInitializeBasicAcpi@@YAXPEAX@Z:PROC		; AuInitializeBasicAcpi
EXTRN	?AuGetNumCPU@@YAEXZ:PROC			; AuGetNumCPU
EXTRN	?AuVFSInit@@YAXXZ:PROC				; AuVFSInit
EXTRN	?AuInitializeScheduler@@YAXXZ:PROC		; AuInitializeScheduler
EXTRN	?AuSchedulerStart@@YAXXZ:PROC			; AuSchedulerStart
EXTRN	?dwm_ipc_init@@YAXXZ:PROC			; dwm_ipc_init
EXTRN	?AuInitializeScreen@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z:PROC ; AuInitializeScreen
EXTRN	?AuCreateProcess@@YAHPEBDPEAD@Z:PROC		; AuCreateProcess
EXTRN	?process_list_initialize@@YAXXZ:PROC		; process_list_initialize
EXTRN	?AuDrvMngrInitialize@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z:PROC ; AuDrvMngrInitialize
EXTRN	?AuInitializeSerial@@YAXXZ:PROC			; AuInitializeSerial
EXTRN	?AuSoundInitialize@@YAXXZ:PROC			; AuSoundInitialize
EXTRN	?AuSoundOutputStart@@YAXXZ:PROC			; AuSoundOutputStart
EXTRN	?AuSoundWrite@@YAXPEAU_vfs_node_@@PEA_KI@Z:PROC	; AuSoundWrite
EXTRN	?pri_loop_init@@YAXXZ:PROC			; pri_loop_init
EXTRN	?AuInitializeShMem@@YAXXZ:PROC			; AuInitializeShMem
EXTRN	?AuSharedDeviceInit@@YAXXZ:PROC			; AuSharedDeviceInit
EXTRN	?ttype_init@@YAXXZ:PROC				; ttype_init
EXTRN	?AuNetInitialize@@YAXXZ:PROC			; AuNetInitialize
EXTRN	?fat32_open@@YA?AU_vfs_node_@@PEAU1@PEAD@Z:PROC	; fat32_open
EXTRN	?fat32_read@@YAXPEAU_vfs_node_@@PEA_K@Z:PROC	; fat32_read
pdata	SEGMENT
$pdata$?debug_print@@YAXPEBDZZ DD imagerel $LN3
	DD	imagerel $LN3+40
	DD	imagerel $unwind$?debug_print@@YAXPEBDZZ
$pdata$?_AuMain@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z DD imagerel $LN13
	DD	imagerel $LN13+683
	DD	imagerel $unwind$?_AuMain@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z
pdata	ENDS
xdata	SEGMENT
$unwind$?debug_print@@YAXPEBDZZ DD 011801H
	DD	04218H
$unwind$?_AuMain@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z DD 040e01H
	DD	033010eH
	DD	060067007H
xdata	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\xeneva\aurora\aurora\init.cpp
_TEXT	SEGMENT
i$1 = 32
i$2 = 36
au_status$ = 40
buffer$3 = 48
pos$ = 56
tv79 = 64
file$ = 80
$T4 = 192
$T5 = 296
info$ = 432
?_AuMain@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z PROC		; _AuMain

; 97   : void _AuMain (KERNEL_BOOT_INFO *info) {

$LN13:
	mov	QWORD PTR [rsp+8], rcx
	push	rsi
	push	rdi
	sub	rsp, 408				; 00000198H

; 98   : 	debug = info->printf_gui;

	mov	rax, QWORD PTR info$[rsp]
	mov	rax, QWORD PTR [rax+106]
	mov	QWORD PTR ?debug@@3P6AXPEBDZZEA, rax	; debug

; 99   : 	//! Initialize the memory mappings
; 100  : 	AuPmmngrInit (info);

	mov	rcx, QWORD PTR info$[rsp]
	call	?AuPmmngrInit@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z ; AuPmmngrInit

; 101  : 	AuPagingInit();

	call	?AuPagingInit@@YAXXZ			; AuPagingInit

; 102  : 	AuHeapInitialize();

	call	?AuHeapInitialize@@YAXXZ		; AuHeapInitialize

; 103  : 	
; 104  : 
; 105  : 	AuInitializeShMem();

	call	?AuInitializeShMem@@YAXXZ		; AuInitializeShMem

; 106  : 	AuHalInitialize();

	call	?AuHalInitialize@@YAXXZ			; AuHalInitialize

; 107  : 
; 108  : 	AuInitializeSerial();

	call	?AuInitializeSerial@@YAXXZ		; AuInitializeSerial

; 109  : 	AuInitializeBasicAcpi (info->acpi_table_pointer);

	mov	rax, QWORD PTR info$[rsp]
	mov	rcx, QWORD PTR [rax+82]
	call	?AuInitializeBasicAcpi@@YAXPEAX@Z	; AuInitializeBasicAcpi

; 110  : 	AuSharedDeviceInit();

	call	?AuSharedDeviceInit@@YAXXZ		; AuSharedDeviceInit

; 111  : 	ahci_initialize();

	call	?ahci_initialize@@YAXXZ			; ahci_initialize

; 112  : 	AuVFSInit();

	call	?AuVFSInit@@YAXXZ			; AuVFSInit

; 113  : 	
; 114  : 	AuInitializeScreen(info);

	mov	rcx, QWORD PTR info$[rsp]
	call	?AuInitializeScreen@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z ; AuInitializeScreen

; 115  : 	AuConsoleInitialize(info);

	mov	rcx, QWORD PTR info$[rsp]
	call	?AuConsoleInitialize@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z ; AuConsoleInitialize

; 116  : 	AuSoundInitialize();

	call	?AuSoundInitialize@@YAXXZ		; AuSoundInitialize

; 117  : 	AuInitializeRTC(); 

	call	?AuInitializeRTC@@YAXXZ			; AuInitializeRTC

; 118  : 
; 119  : 	AuInitializeMouse();

	call	?AuInitializeMouse@@YAXXZ		; AuInitializeMouse

; 120  : 
; 121  : 	AuNetInitialize();

	call	?AuNetInitialize@@YAXXZ			; AuNetInitialize

; 122  : 	
; 123  : 	
; 124  : 	//================================================
; 125  : 	//! Initialize the scheduler here
; 126  : 	//!===============================================
; 127  : 	AuInitializeScheduler();

	call	?AuInitializeScheduler@@YAXXZ		; AuInitializeScheduler

; 128  : 
; 129  : 	//Here we initialise all drivers stuffs
; 130  : 	/* Clear interrupts as scheduler will enable it */
; 131  : 	x64_cli();

	call	x64_cli

; 132  : 	AuDrvMngrInitialize(info);

	mov	rcx, QWORD PTR info$[rsp]
	call	?AuDrvMngrInitialize@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z ; AuDrvMngrInitialize

; 133  : 	//hda_initialize();
; 134  : 	AuKeyboardInitialize();

	call	?AuKeyboardInitialize@@YAXXZ		; AuKeyboardInitialize

; 135  : 	dwm_ipc_init();

	call	?dwm_ipc_init@@YAXXZ			; dwm_ipc_init

; 136  : 	pri_loop_init();

	call	?pri_loop_init@@YAXXZ			; pri_loop_init

; 137  : 
; 138  : 	process_list_initialize();

	call	?process_list_initialize@@YAXXZ		; process_list_initialize

; 139  : 	ttype_init();

	call	?ttype_init@@YAXXZ			; ttype_init

; 140  : 
; 141  : 	/*Initialize other processor */
; 142  : 	AuInitializeCpu(AuGetNumCPU());

	call	?AuGetNumCPU@@YAEXZ			; AuGetNumCPU
	movzx	ecx, al
	call	?AuInitializeCpu@@YAXE@Z		; AuInitializeCpu

; 143  : 
; 144  : 	
; 145  : 	/*Clear the lower half for user space */
; 146  : 	AuPagingClearLow();

	call	?AuPagingClearLow@@YAXXZ		; AuPagingClearLow

; 147  : 
; 148  : 	uint64_t pos = (uint64_t)0xFFFFF00000000000;

	mov	rax, -17592186044416			; fffff00000000000H
	mov	QWORD PTR pos$[rsp], rax

; 149  : 	for (int i = 0; i < 5*1024*1024/4096; i++)

	mov	DWORD PTR i$2[rsp], 0
	jmp	SHORT $LN10@AuMain
$LN9@AuMain:
	mov	eax, DWORD PTR i$2[rsp]
	inc	eax
	mov	DWORD PTR i$2[rsp], eax
$LN10@AuMain:
	cmp	DWORD PTR i$2[rsp], 1280		; 00000500H
	jge	SHORT $LN8@AuMain

; 150  : 		AuMapPage((uint64_t)AuPmmngrAlloc(),pos + i * 4096, 0);

	mov	eax, DWORD PTR i$2[rsp]
	imul	eax, 4096				; 00001000H
	cdqe
	mov	rcx, QWORD PTR pos$[rsp]
	add	rcx, rax
	mov	rax, rcx
	mov	QWORD PTR tv79[rsp], rax
	call	AuPmmngrAlloc
	xor	r8d, r8d
	mov	rcx, QWORD PTR tv79[rsp]
	mov	rdx, rcx
	mov	rcx, rax
	call	AuMapPage
	jmp	SHORT $LN9@AuMain
$LN8@AuMain:

; 151  : 
; 152  : 	//AuARPRequestMAC();
; 153  : 	x64_sti();

	call	x64_sti

; 154  : 	vfs_node_t file = fat32_open(NULL, "/mon.wav");

	lea	r8, OFFSET FLAT:$SG5388
	xor	edx, edx
	lea	rcx, QWORD PTR $T5[rsp]
	call	?fat32_open@@YA?AU_vfs_node_@@PEAU1@PEAD@Z ; fat32_open
	lea	rcx, QWORD PTR $T4[rsp]
	mov	rdi, rcx
	mov	rsi, rax
	mov	ecx, 104				; 00000068H
	rep movsb
	lea	rax, QWORD PTR file$[rsp]
	lea	rcx, QWORD PTR $T4[rsp]
	mov	rdi, rax
	mov	rsi, rcx
	mov	ecx, 104				; 00000068H
	rep movsb

; 155  : 	printf ("file.size -> %d \n", file.size);

	mov	edx, DWORD PTR file$[rsp+32]
	lea	rcx, OFFSET FLAT:$SG5389
	call	printf

; 156  : 
; 157  : 	for (int i = 0; i < 5*1024*1024/4096; i++) {

	mov	DWORD PTR i$1[rsp], 0
	jmp	SHORT $LN7@AuMain
$LN6@AuMain:
	mov	eax, DWORD PTR i$1[rsp]
	inc	eax
	mov	DWORD PTR i$1[rsp], eax
$LN7@AuMain:
	cmp	DWORD PTR i$1[rsp], 1280		; 00000500H
	jge	SHORT $LN5@AuMain

; 158  : 		uint64_t* buffer = (uint64_t*)p2v((size_t)AuPmmngrAlloc());

	call	AuPmmngrAlloc
	mov	rcx, rax
	call	p2v
	mov	QWORD PTR buffer$3[rsp], rax

; 159  : 		memset(buffer, 0, 4096);

	mov	r8d, 4096				; 00001000H
	xor	edx, edx
	mov	rcx, QWORD PTR buffer$3[rsp]
	call	memset

; 160  : 		fat32_read(&file, (uint64_t*)v2p((size_t)buffer));

	mov	rcx, QWORD PTR buffer$3[rsp]
	call	v2p
	mov	rdx, rax
	lea	rcx, QWORD PTR file$[rsp]
	call	?fat32_read@@YAXPEAU_vfs_node_@@PEA_K@Z	; fat32_read

; 161  : 		memcpy((void*)(pos + i * 4096),buffer,4096);

	mov	eax, DWORD PTR i$1[rsp]
	imul	eax, 4096				; 00001000H
	cdqe
	mov	rcx, QWORD PTR pos$[rsp]
	add	rcx, rax
	mov	rax, rcx
	mov	r8d, 4096				; 00001000H
	mov	rdx, QWORD PTR buffer$3[rsp]
	mov	rcx, rax
	call	memcpy

; 162  : 		AuPmmngrFree((void*)v2p((size_t)buffer));

	mov	rcx, QWORD PTR buffer$3[rsp]
	call	v2p
	mov	rcx, rax
	call	AuPmmngrFree

; 163  : 	}

	jmp	$LN6@AuMain
$LN5@AuMain:

; 164  : 	AuSoundWrite(NULL, (uint64_t*)pos,4096);

	mov	r8d, 4096				; 00001000H
	mov	rdx, QWORD PTR pos$[rsp]
	xor	ecx, ecx
	call	?AuSoundWrite@@YAXPEAU_vfs_node_@@PEA_KI@Z ; AuSoundWrite

; 165  : 	AuSoundOutputStart();

	call	?AuSoundOutputStart@@YAXXZ		; AuSoundOutputStart
$LN4@AuMain:

; 166  : 	for(;;);

	jmp	SHORT $LN4@AuMain

; 167  : #ifdef ARCH_X64
; 168  : 
; 169  : 	printf ("Scheduler Initialized\n");

	lea	rcx, OFFSET FLAT:$SG5406
	call	printf

; 170  : 	int au_status = 0;

	mov	DWORD PTR au_status$[rsp], 0

; 171  : 
; 172  : 	/* start the sound service manager at id 1 */
; 173  : 	au_status = AuCreateProcess ("/init.exe","shell");

	lea	rdx, OFFSET FLAT:$SG5408
	lea	rcx, OFFSET FLAT:$SG5409
	call	?AuCreateProcess@@YAHPEBDPEAD@Z		; AuCreateProcess
	mov	DWORD PTR au_status$[rsp], eax

; 174  : 
; 175  : 	/* start the compositing window manager at id 3 */
; 176  : 	au_status = AuCreateProcess ("/priwm.exe","priwm");

	lea	rdx, OFFSET FLAT:$SG5410
	lea	rcx, OFFSET FLAT:$SG5411
	call	?AuCreateProcess@@YAHPEBDPEAD@Z		; AuCreateProcess
	mov	DWORD PTR au_status$[rsp], eax

; 177  : 
; 178  : 	//au_status = AuCreateProcess ("/dock.exe", "dock");
; 179  : 	//! Here start the scheduler (multitasking engine)
; 180  : 	AuSchedulerStart();

	call	?AuSchedulerStart@@YAXXZ		; AuSchedulerStart
$LN2@AuMain:

; 181  : #endif
; 182  : 
; 183  : 	//! Loop forever
; 184  : 	while(1) {

	xor	eax, eax
	cmp	eax, 1
	je	SHORT $LN1@AuMain

; 185  : 		//!looping looping
; 186  : 		x64_cli();

	call	x64_cli

; 187  : 		x64_hlt();

	call	x64_hlt

; 188  : 	}

	jmp	SHORT $LN2@AuMain
$LN1@AuMain:

; 189  : }

	add	rsp, 408				; 00000198H
	pop	rdi
	pop	rsi
	ret	0
?_AuMain@@YAXPEAU_KERNEL_BOOT_INFO_@@@Z ENDP		; _AuMain
_TEXT	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\xeneva\aurora\aurora\init.cpp
_TEXT	SEGMENT
text$ = 48
?debug_print@@YAXPEBDZZ PROC				; debug_print

; 89   : void debug_print (const char* text, ...) {

$LN3:
	mov	QWORD PTR [rsp+8], rcx
	mov	QWORD PTR [rsp+16], rdx
	mov	QWORD PTR [rsp+24], r8
	mov	QWORD PTR [rsp+32], r9
	sub	rsp, 40					; 00000028H

; 90   : 	debug(text);

	mov	rcx, QWORD PTR text$[rsp]
	call	QWORD PTR ?debug@@3P6AXPEBDZZEA		; debug

; 91   : }

	add	rsp, 40					; 00000028H
	ret	0
?debug_print@@YAXPEBDZZ ENDP				; debug_print
_TEXT	ENDS
END
